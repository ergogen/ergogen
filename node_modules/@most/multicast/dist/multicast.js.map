{"version":3,"file":null,"sources":["../src/MulticastDisposable.js","../src/tryEvent.js","../src/dispose.js","../src/MulticastSource.js","../src/index.js"],"sourcesContent":["export default class MulticastDisposable {\n  constructor (source, sink) {\n    this.source = source\n    this.sink = sink\n    this.disposed = false\n  }\n\n  dispose () {\n    if (this.disposed) {\n      return\n    }\n    this.disposed = true\n    const remaining = this.source.remove(this.sink)\n    return remaining === 0 && this.source._dispose()\n  }\n}\n","export function tryEvent (t, x, sink) {\n  try {\n    sink.event(t, x)\n  } catch (e) {\n    sink.error(t, e)\n  }\n}\n\nexport function tryEnd (t, x, sink) {\n  try {\n    sink.end(t, x)\n  } catch (e) {\n    sink.error(t, e)\n  }\n}\n","export const dispose = disposable => disposable.dispose()\n\nexport const emptyDisposable = {\n  dispose () {}\n}\n","import MulticastDisposable from './MulticastDisposable'\nimport { tryEvent, tryEnd } from './tryEvent'\nimport { dispose, emptyDisposable } from './dispose'\nimport { append, remove, findIndex } from '@most/prelude'\n\nexport default class MulticastSource {\n  constructor (source) {\n    this.source = source\n    this.sinks = []\n    this._disposable = emptyDisposable\n  }\n\n  run (sink, scheduler) {\n    const n = this.add(sink)\n    if (n === 1) {\n      this._disposable = this.source.run(this, scheduler)\n    }\n    return new MulticastDisposable(this, sink)\n  }\n\n  _dispose () {\n    const disposable = this._disposable\n    this._disposable = emptyDisposable\n    return Promise.resolve(disposable).then(dispose)\n  }\n\n  add (sink) {\n    this.sinks = append(sink, this.sinks)\n    return this.sinks.length\n  }\n\n  remove (sink) {\n    const i = findIndex(sink, this.sinks)\n    // istanbul ignore next\n    if (i >= 0) {\n      this.sinks = remove(i, this.sinks)\n    }\n\n    return this.sinks.length\n  }\n\n  event (time, value) {\n    const s = this.sinks\n    if (s.length === 1) {\n      return s[0].event(time, value)\n    }\n    for (let i = 0; i < s.length; ++i) {\n      tryEvent(time, value, s[i])\n    }\n  }\n\n  end (time, value) {\n    const s = this.sinks\n    for (let i = 0; i < s.length; ++i) {\n      tryEnd(time, value, s[i])\n    }\n  }\n\n  error (time, err) {\n    const s = this.sinks\n    for (let i = 0; i < s.length; ++i) {\n      s[i].error(time, err)\n    }\n  }\n}\n","import MulticastSource from './MulticastSource'\n\nfunction multicast (stream) {\n  const source = stream.source\n  return source instanceof MulticastSource\n    ? stream\n    : new stream.constructor(new MulticastSource(source))\n}\n\nexport {multicast as default, MulticastSource}\n"],"names":["const","append","findIndex","remove","let"],"mappings":";;;;;;AAAe,IAAM,mBAAmB,GAAC,4BAC5B,EAAE,MAAM,EAAE,IAAI,EAAE;EAC3B,IAAM,CAAC,MAAM,GAAG,MAAM;EACtB,IAAM,CAAC,IAAI,GAAG,IAAI;EAClB,IAAM,CAAC,QAAQ,GAAG,KAAK;CACtB,CAAA;;AAEH,8BAAE,OAAO,uBAAI;EACX,IAAM,IAAI,CAAC,QAAQ,EAAE;IACnB,MAAQ;GACP;EACH,IAAM,CAAC,QAAQ,GAAG,IAAI;EACtB,IAAQ,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC;EACjD,OAAS,SAAS,KAAK,CAAC,IAAI,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE;CACjD,CAAA;;ACdI,SAAS,QAAQ,EAAE,CAAC,EAAE,CAAC,EAAE,IAAI,EAAE;EACpC,IAAI;IACF,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;GACjB,CAAC,OAAO,CAAC,EAAE;IACV,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;GACjB;CACF;;AAED,AAAO,SAAS,MAAM,EAAE,CAAC,EAAE,CAAC,EAAE,IAAI,EAAE;EAClC,IAAI;IACF,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,CAAC;GACf,CAAC,OAAO,CAAC,EAAE;IACV,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC;GACjB;CACF;;ACdMA,IAAM,OAAO,GAAG,UAAA,UAAU,EAAC,SAAG,UAAU,CAAC,OAAO,EAAE,GAAA;;AAEzD,AAAOA,IAAM,eAAe,GAAG;EAC7B,OAAO,oBAAA,IAAI,EAAE;CACd;;ACCD,IAAqB,eAAe,GAAC,wBACxB,EAAE,MAAM,EAAE;EACrB,IAAM,CAAC,MAAM,GAAG,MAAM;EACtB,IAAM,CAAC,KAAK,GAAG,EAAE;EACjB,IAAM,CAAC,WAAW,GAAG,eAAe;CACnC,CAAA;;AAEH,0BAAE,GAAG,iBAAE,IAAI,EAAE,SAAS,EAAE;EACtB,IAAQ,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC;EAC1B,IAAM,CAAC,KAAK,CAAC,EAAE;IACb,IAAM,CAAC,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,IAAI,EAAE,SAAS,CAAC;GACpD;EACH,OAAS,IAAI,mBAAmB,CAAC,IAAI,EAAE,IAAI,CAAC;CAC3C,CAAA;;AAEH,0BAAE,QAAQ,wBAAI;EACZ,IAAQ,UAAU,GAAG,IAAI,CAAC,WAAW;EACrC,IAAM,CAAC,WAAW,GAAG,eAAe;EACpC,OAAS,OAAO,CAAC,OAAO,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC;CACjD,CAAA;;AAEH,0BAAE,GAAG,iBAAE,IAAI,EAAE;EACX,IAAM,CAAC,KAAK,GAAGC,oBAAM,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC;EACvC,OAAS,IAAI,CAAC,KAAK,CAAC,MAAM;CACzB,CAAA;;AAEH,0BAAE,MAAM,sBAAE,IAAI,EAAE;EACd,IAAQ,CAAC,GAAGC,uBAAS,CAAC,IAAI,EAAE,IAAI,CAAC,KAAK,CAAC;;EAEvC,IAAM,CAAC,IAAI,CAAC,EAAE;IACZ,IAAM,CAAC,KAAK,GAAGC,oBAAM,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC;GACnC;;EAEH,OAAS,IAAI,CAAC,KAAK,CAAC,MAAM;CACzB,CAAA;;AAEH,0BAAE,KAAK,mBAAE,IAAI,EAAE,KAAK,EAAE;EACpB,IAAQ,CAAC,GAAG,IAAI,CAAC,KAAK;EACtB,IAAM,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE;IACpB,OAAS,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,KAAK,CAAC;GAC/B;EACH,KAAOC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;IACnC,QAAU,CAAC,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;GAC5B;CACF,CAAA;;AAEH,0BAAE,GAAG,iBAAE,IAAI,EAAE,KAAK,EAAE;EAClB,IAAQ,CAAC,GAAG,IAAI,CAAC,KAAK;EACtB,KAAOA,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;IACnC,MAAQ,CAAC,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;GAC1B;CACF,CAAA;;AAEH,0BAAE,KAAK,mBAAE,IAAI,EAAE,GAAG,EAAE;EAClB,IAAQ,CAAC,GAAG,IAAI,CAAC,KAAK;EACtB,KAAOA,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE;IACnC,CAAG,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,GAAG,CAAC;GACtB;CACF,CAAA;;AC7DH,SAAS,SAAS,EAAE,MAAM,EAAE;EAC1BJ,IAAM,MAAM,GAAG,MAAM,CAAC,MAAM;EAC5B,OAAO,MAAM,YAAY,eAAe;MACpC,MAAM;MACN,IAAI,MAAM,CAAC,WAAW,CAAC,IAAI,eAAe,CAAC,MAAM,CAAC,CAAC;CACxD,AAED;;;;;;;"}